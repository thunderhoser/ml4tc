#!/bin/tcsh

#SBATCH --job-name="make_saliency_maps"
#SBATCH --partition="fge"
#SBATCH --account="rda-ghpcs"
#SBATCH --qos="batch"
#SBATCH --ntasks=1
#SBATCH --nodes=1
#SBATCH --cpus-per-task=1
#SBATCH --time=30:00:00
#SBATCH --array=1-180
#SBATCH --exclude=h28n12
##SBATCH --exclude=h31n03,h28n12
##SBATCH --exclude=h29n01,h26n05,h28n06,h29n07,h30n03,h30n15
#SBATCH --mail-type=BEGIN,END,FAIL
#SBATCH --mail-user=ryan.lagerquist@noaa.gov
#SBATCH --output=make_saliency_maps_%A_%a.out

module load cuda/10.1
source /scratch2/BMC/gsd-hpcs/Jebb.Q.Stewart/conda3.7/etc/profile.d/conda.csh
conda activate base

set CODE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4tc_standalone/ml4tc"
set EXAMPLE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4tc_project/learning_examples/rotated_with_storm_motion/imputed/normalized"
set TOP_MODEL_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4tc_models/experiment13"

set SAMPLE_SIZES=(25 25 25 25 25 46 46 46 46 46 83 83 83 83 83 151 151 151 151 151 275 275 275 275 275 500 500 500 500 500 25 25 25 25 25 46 46 46 46 46 83 83 83 83 83 151 151 151 151 151 275 275 275 275 275 500 500 500 500 500 25 25 25 25 25 46 46 46 46 46 83 83 83 83 83 151 151 151 151 151 275 275 275 275 275 500 500 500 500 500 25 25 25 25 25 46 46 46 46 46 83 83 83 83 83 151 151 151 151 151 275 275 275 275 275 500 500 500 500 500 25 25 25 25 25 46 46 46 46 46 83 83 83 83 83 151 151 151 151 151 275 275 275 275 275 500 500 500 500 500 25 25 25 25 25 46 46 46 46 46 83 83 83 83 83 151 151 151 151 151 275 275 275 275 275 500 500 500 500 500)
set NOISE_STDEVS=(0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000)
set CYCLONE_ID_STRINGS=("2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21")

set sample_size=${SAMPLE_SIZES[$SLURM_ARRAY_TASK_ID]}
set sample_size=`printf "%03d" $sample_size`
set noise_stdev=${NOISE_STDEVS[$SLURM_ARRAY_TASK_ID]}
set noise_stdev=`printf "%.10f" $noise_stdev`
set cyclone_id_string=${CYCLONE_ID_STRINGS[$SLURM_ARRAY_TASK_ID]}

set LAG_TIME_COUNTS=(21 3 2)
set SHIPS_LAGGED_PREDICTOR_GROUP_STRINGS=("fractions-smallrad" "largerad-smallrad" "none")
set USE_DATA_AUG_FLAGS=(1 1 1)
set LAYER_NAMES=("activation_16" "activation_9" "activation")
set i=2

while ($i <= ${#LAG_TIME_COUNTS})
    set lag_time_count=${LAG_TIME_COUNTS[$i]}
    set lag_time_count=`printf "%02d" $lag_time_count`
    set ships_lagged_predictor_group_string=${SHIPS_LAGGED_PREDICTOR_GROUP_STRINGS[$i]}
    set use_data_aug_flag=${USE_DATA_AUG_FLAGS[$i]}

    set model_dir_name="${TOP_MODEL_DIR_NAME}/num-lag-times=${lag_time_count}_lagged-ships-predictors=${ships_lagged_predictor_group_string}_data-aug=${use_data_aug_flag}"
    set model_file_name="${model_dir_name}/model.h5"
    set output_file_name="${model_dir_name}/smoothgrad_experiment/sample-size=${sample_size}_noise-stdev=${noise_stdev}/saliency_maps_${cyclone_id_string}.nc"

    python3 -u "${CODE_DIR_NAME}/make_saliency_maps.py" \
    --input_model_file_name="${model_file_name}" \
    --input_example_dir_name="${EXAMPLE_DIR_NAME}" \
    --cyclone_id_strings ${cyclone_id_string} \
    --layer_name="${LAYER_NAMES[$i]}" \
    --neuron_indices 0 \
    --ideal_activation=1 \
    --num_smoothgrad_samples=${sample_size} \
    --smoothgrad_noise_stdev=${noise_stdev} \
    --output_file_name="${output_file_name}"
    
    @ i = $i + 1
end
