#!/bin/tcsh

#SBATCH --job-name="split_predictions_by_month_and_basin"
#SBATCH --partition="fge"
#SBATCH --account="rda-ghpcs"
#SBATCH --qos="batch"
#SBATCH --ntasks=1
#SBATCH --nodes=1
#SBATCH --cpus-per-task=1
#SBATCH --time=12:00:00
#SBATCH --array=1-125
#SBATCH --exclude=h28n12
##SBATCH --exclude=h31n03,h28n12
##SBATCH --exclude=h29n01,h26n05,h28n06,h29n07,h30n03,h30n15
#SBATCH --mail-type=BEGIN,END,FAIL
#SBATCH --mail-user=ryan.lagerquist@noaa.gov
#SBATCH --output=split_predictions_by_month_and_basin_%A_%a.out

module load cuda/10.1
source /scratch2/BMC/gsd-hpcs/Jebb.Q.Stewart/conda3.7/etc/profile.d/conda.csh
conda activate base

set CODE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4tc_standalone/ml4tc"
set TOP_MODEL_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4tc_models/mcd_experiment01_td-to-ts"

set FOURTH_LAST_LAYER_DROPOUT_RATES=(0.000 0.000 0.000 0.000 0.000 0.125 0.125 0.125 0.125 0.125 0.250 0.250 0.250 0.250 0.250 0.375 0.375 0.375 0.375 0.375 0.500 0.500 0.500 0.500 0.500 0.000 0.000 0.000 0.000 0.000 0.125 0.125 0.125 0.125 0.125 0.250 0.250 0.250 0.250 0.250 0.375 0.375 0.375 0.375 0.375 0.500 0.500 0.500 0.500 0.500 0.000 0.000 0.000 0.000 0.000 0.125 0.125 0.125 0.125 0.125 0.250 0.250 0.250 0.250 0.250 0.375 0.375 0.375 0.375 0.375 0.500 0.500 0.500 0.500 0.500 0.000 0.000 0.000 0.000 0.000 0.125 0.125 0.125 0.125 0.125 0.250 0.250 0.250 0.250 0.250 0.375 0.375 0.375 0.375 0.375 0.500 0.500 0.500 0.500 0.500 0.000 0.000 0.000 0.000 0.000 0.125 0.125 0.125 0.125 0.125 0.250 0.250 0.250 0.250 0.250 0.375 0.375 0.375 0.375 0.375 0.500 0.500 0.500 0.500 0.500)
set THIRD_LAST_LAYER_DROPOUT_RATES=(0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500)
set SECOND_LAST_LAYER_DROPOUT_RATES=(0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500 0.000 0.125 0.250 0.375 0.500)

set fourth_last_layer_dropout_rate=${FOURTH_LAST_LAYER_DROPOUT_RATES[$SLURM_ARRAY_TASK_ID]}
set third_last_layer_dropout_rate=${THIRD_LAST_LAYER_DROPOUT_RATES[$SLURM_ARRAY_TASK_ID]}
set second_last_layer_dropout_rate=${SECOND_LAST_LAYER_DROPOUT_RATES[$SLURM_ARRAY_TASK_ID]}

set fourth_last_layer_dropout_rate=`printf "%.3f" $fourth_last_layer_dropout_rate`
set third_last_layer_dropout_rate=`printf "%.3f" $third_last_layer_dropout_rate`
set second_last_layer_dropout_rate=`printf "%.3f" $second_last_layer_dropout_rate`

set model_dir_name="${TOP_MODEL_DIR_NAME}/dropout-rates=${fourth_last_layer_dropout_rate}-${third_last_layer_dropout_rate}-${second_last_layer_dropout_rate}"
set input_file_name="${model_dir_name}/validation/predictions.nc"
set output_dir_name="${model_dir_name}/validation"

python3 -u "${CODE_DIR_NAME}/split_predictions_by_month_and_basin.py" \
--input_prediction_file_name="${input_file_name}" \
--output_prediction_dir_name="${output_dir_name}"
