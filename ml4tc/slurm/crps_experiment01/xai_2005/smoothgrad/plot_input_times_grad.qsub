#!/bin/tcsh

#SBATCH --job-name="plot_input_times_grad"
#SBATCH --partition="fge"
#SBATCH --account="rda-ghpcs"
#SBATCH --qos="batch"
#SBATCH --ntasks=1
#SBATCH --nodes=1
#SBATCH --cpus-per-task=1
#SBATCH --time=12:00:00
#SBATCH --array=1-180
#SBATCH --exclude=h28n12
##SBATCH --exclude=h31n03,h28n12
##SBATCH --exclude=h29n01,h26n05,h28n06,h29n07,h30n03,h30n15
#SBATCH --mail-type=BEGIN,END,FAIL
#SBATCH --mail-user=ryan.lagerquist@noaa.gov
#SBATCH --output=plot_input_times_grad_%A_%a.out

module load cuda/10.1
source /scratch2/BMC/gsd-hpcs/Jebb.Q.Stewart/conda3.7/etc/profile.d/conda.csh
conda activate base

set CODE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4tc_standalone/ml4tc"
set EXAMPLE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4tc_project/learning_examples/rotated_with_storm_motion/imputed/normalized"
set NORMALIZATION_FILE_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4tc_project/learning_examples/rotated_with_storm_motion/normalization_params_1993-2004_2015-2019.nc"
set TOP_MODEL_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4tc_models/crps_experiment01"

set SAMPLE_SIZES=(25 25 25 25 25 46 46 46 46 46 83 83 83 83 83 151 151 151 151 151 275 275 275 275 275 500 500 500 500 500 25 25 25 25 25 46 46 46 46 46 83 83 83 83 83 151 151 151 151 151 275 275 275 275 275 500 500 500 500 500 25 25 25 25 25 46 46 46 46 46 83 83 83 83 83 151 151 151 151 151 275 275 275 275 275 500 500 500 500 500 25 25 25 25 25 46 46 46 46 46 83 83 83 83 83 151 151 151 151 151 275 275 275 275 275 500 500 500 500 500 25 25 25 25 25 46 46 46 46 46 83 83 83 83 83 151 151 151 151 151 275 275 275 275 275 500 500 500 500 500 25 25 25 25 25 46 46 46 46 46 83 83 83 83 83 151 151 151 151 151 275 275 275 275 275 500 500 500 500 500)
set NOISE_STDEVS=(0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1000000000 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.1820564203 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.3314454017 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 0.6034176337 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 1.0985605433 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000 2.0000000000)
set CYCLONE_ID_STRINGS=("2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21" "2005AL12" "2005AL17" "2005EP11" "2005WP10" "2005WP21")

set sample_size=${SAMPLE_SIZES[$SLURM_ARRAY_TASK_ID]}
set sample_size=`printf "%03d" $sample_size`
set noise_stdev=${NOISE_STDEVS[$SLURM_ARRAY_TASK_ID]}
set noise_stdev=`printf "%.10f" $noise_stdev`
set cyclone_id_string=${CYCLONE_ID_STRINGS[$SLURM_ARRAY_TASK_ID]}

set FOURTH_LAST_LAYER_DROPOUT_RATES=("0.700" "0.900" "0.300" "0.500" "0.300" "0.900" "0.100")
set THIRD_LAST_LAYER_DROPOUT_RATES=("0.700" "0.500" "0.300" "0.500" "0.500" "0.100" "0.500")
set SECOND_LAST_LAYER_DROPOUT_RATES=("0.500" "0.300" "0.900" "0.100" "0.900" "0.500" "0.300")
set LAYER_NAMES=("activation_68" "activation_39" "activation_106" "activation_12" "activation_111" "activation_54" "activation_35")

set i=1

while ($i <= ${#FOURTH_LAST_LAYER_DROPOUT_RATES})
    set fourth_last_layer_dropout_rate=${FOURTH_LAST_LAYER_DROPOUT_RATES[$i]}
    set third_last_layer_dropout_rate=${THIRD_LAST_LAYER_DROPOUT_RATES[$i]}
    set second_last_layer_dropout_rate=${SECOND_LAST_LAYER_DROPOUT_RATES[$i]}

    set model_dir_name="${TOP_MODEL_DIR_NAME}/dropout-rates=${fourth_last_layer_dropout_rate}-${third_last_layer_dropout_rate}-${second_last_layer_dropout_rate}"
    set prediction_file_name="${model_dir_name}/validation/predictions.nc"
    set saliency_file_name="${model_dir_name}/smoothgrad_experiment/sample-size=${sample_size}_noise-stdev=${noise_stdev}/saliency_maps_${cyclone_id_string}.nc"
    set output_dir_name="${model_dir_name}/smoothgrad_experiment/sample-size=${sample_size}_noise-stdev=${noise_stdev}/input_times_grad_maps_${cyclone_id_string}"

    python3 -u "${CODE_DIR_NAME}/plot_saliency_maps.py" \
    --input_saliency_file_name="${saliency_file_name}" \
    --input_example_dir_name="${EXAMPLE_DIR_NAME}" \
    --input_normalization_file_name="${NORMALIZATION_FILE_NAME}" \
    --input_prediction_file_name="${prediction_file_name}" \
    --plot_input_times_grad=1 \
    --smoothing_radius_px=-1 \
    --output_dir_name="${output_dir_name}"
    
    @ i = $i + 1
end
